{
  "id" : "appapp_user_item_preferences_aggregation",
  "hiddenParameters" : [ {
    "key" : "signalTypes",
    "value" : "_regex/signalTypeWeights/([\\w\\-\\.]*):([\\d\\.\\-]*)(,|$)/'$1'$3/g"
  } ],
  "notes" : "Computes an aggregated weight for each user / item combination found in the signals collection. The weight for each group is computed using an exponential time-decay on signal count (30 day half-life) and a weighted sum based on the signal type. Use the 'signalTypeWeights' parameter to set the correct signal types and weights for your dataset. The results of this job can be used as input to the ALS recommendation job.",
  "sourceRemove" : false,
  "useNaturalKey" : true,
  "sourceCatchup" : true,
  "skipCheckEnabled" : true,
  "type" : "sql_template",
  "outputCollection" : "appapp_signals_aggr",
  "parameters" : [ {
    "key" : "signalTypeWeights",
    "value" : "click:1.0,cart:10.0,purchase:25.0"
  } ],
  "selectQuery" : "*:*",
  "inputCollection" : "appapp_signals",
  "sql" : "WITH signal_type_groups AS (\n    SELECT SUM(count_i) AS typed_aggr_count_i,\n           doc_id,\n           user_id,\n           type,\n           time_decay(count_i, timestamp_tdt, \"30 days\", ref_time, weight_d) AS typed_weight_d\n      FROM ${inputCollection}\n     WHERE type IN (${signalTypes})\n  GROUP BY user_id, doc_id, type\n ) SELECT SUM(typed_aggr_count_i) AS aggr_count_i,\n          doc_id AS doc_id_s,\n          user_id AS user_id_s,\n          weighted_sum(typed_weight_d, type, '${signalTypeWeights}') AS weight_d\n     FROM signal_type_groups\n GROUP BY doc_id, user_id"
}